<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Samity Portal (Final)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --bg:#f5f7fb; --card:#fff; --muted:#6b7280; --accent:#0b69ff; --success:#059669; --danger:#dc2626; font-family:system-ui,-apple-system,segoe ui,Roboto,Arial; }
    body { background:var(--bg); margin:0; color:#111827; padding:18px; }
    .container { max-width:1150px; margin:0 auto; }
    header { display:flex; align-items:center; gap:12px; margin-bottom:16px; }
    h1 { margin:0; font-size:20px; }
    nav { display:flex; gap:8px; }
    .tabbtn { padding:8px 12px; border-radius:6px; border:1px solid #e5e7eb; background:#fff; cursor:pointer; }
    .tabbtn.active { background:var(--accent); color:white; border-color:transparent; }
    .card { background:var(--card); padding:14px; border-radius:10px; box-shadow:0 1px 3px rgba(0,0,0,0.06); margin-bottom:14px; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    input[type="text"], input[type="number"], input[type="date"] { padding:8px; border:1px solid #d1d5db; border-radius:6px; min-width:160px; }
    table { width:100%; border-collapse:collapse; margin-top:10px; font-size:14px; }
    th, td { border:1px solid #e6e7ea; padding:8px; text-align:left; vertical-align:middle; }
    th { background:#f3f4f6; font-size:13px; }
    .due { background:#fff1f2; color:var(--danger); font-weight:700; }
    .muted { color:var(--muted); font-size:13px; }
    .btn { padding:6px 10px; border-radius:6px; border:0; cursor:pointer; font-size:13px; }
    .btn.primary { background:var(--accent); color:white; }
    .btn.green { background:var(--success); color:white; }
    .btn.red { background:var(--danger); color:white; }
    .btn.gray { background:#f3f4f6; }
    .small { font-size:13px; color:var(--muted); }
    @media (max-width:720px){ .row { flex-direction:column; } }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Samity Portal</h1>
      <nav id="nav"></nav>
      <div style="margin-left:auto" class="small muted">Unit ₹50 | Fine ₹5/share | Interest 3%/month (simple)</div>
    </header>

    <!-- Main content areas (we will show/hide sections) -->
    <div id="homeSection" class="card" style="display:none"></div>
    <div id="membersSection" class="card" style="display:none"></div>
    <div id="weeklySection" class="card" style="display:none"></div>
    <div id="loanSection" class="card" style="display:none"></div>
  </div>

  <script>
  (function(){
    // STORAGE KEYS
    const KEY_MEM = 'samity_members_final_v2';
    const KEY_TXN = 'samity_txns_final_v2';

    // CONSTANTS
    const UNIT = 50;
    const FINE_PER_SHARE = 5;
    const MONTHLY_INTEREST_RATE = 0.03; // 3% per month simple interest

    // App state (in-memory)
    let members = load(KEY_MEM) || [];
    let txns = load(KEY_TXN) || [];

    // Utility functions
    function uid(){ return Math.random().toString(36).slice(2,9); }
    function nowLocale(){ return new Date().toLocaleDateString(); }
    function nowISO(){ return new Date().toISOString(); }
    function save(key, val){ localStorage.setItem(key, JSON.stringify(val)); }
    function load(key){ try { return JSON.parse(localStorage.getItem(key)); } catch(e){ return null; } }

    // NAV
    const nav = document.getElementById('nav');
    const tabs = ['home','members','weekly','loan'];
    tabs.forEach(t => {
      const b = document.createElement('button');
      b.textContent = t.charAt(0).toUpperCase() + (t==='weekly' ? 'ly Entry' : t.slice(1));
      b.className = 'tabbtn';
      b.id = 'tab-'+t;
      b.addEventListener('click', ()=> showTab(t));
      nav.appendChild(b);
    });

    // Sections
    const homeSection = document.getElementById('homeSection');
    const membersSection = document.getElementById('membersSection');
    const weeklySection = document.getElementById('weeklySection');
    const loanSection = document.getElementById('loanSection');

    // Render initial UI
    function showTab(tab){
      // set active nav
      tabs.forEach(t => document.getElementById('tab-'+t).classList.toggle('active', t===tab));
      // show/hide
      homeSection.style.display = tab==='home' ? 'block' : 'none';
      membersSection.style.display = tab==='members' ? 'block' : 'none';
      weeklySection.style.display = tab==='weekly' ? 'block' : 'none';
      loanSection.style.display = tab==='loan' ? 'block' : 'none';
      // render content for that tab
      if(tab==='home') renderHome();
      if(tab==='members') renderMembers();
      if(tab==='weekly') renderWeekly();
      if(tab==='loan') renderLoan();
    }

    // INITIAL: show home
    showTab('home');

    /************** DATA AGGREGATES **************/
    function totals(){
      const totalMembers = members.length;
      const totalShares = members.reduce((s,m)=> s + (Number(m.shares)||0), 0);
      const totalDeposits = txns.filter(t=> t.type==='contribution').reduce((s,t)=> s + (t.amount||0), 0);
      const totalLoans = txns.filter(t=> t.type==='loan').reduce((s,t)=> s + (t.amount||0), 0);
      const totalInterestCollected = txns.filter(t=> t.type==='interest').reduce((s,t)=> s + (t.amount||0), 0);
      const totalFineCollected = txns.filter(t=> t.type==='skipped').reduce((s,t)=> s + (t.amount||0), 0);
      const cashBalance = totalDeposits + totalInterestCollected + totalFineCollected - totalLoans;
      return { totalMembers, totalShares, totalDeposits, totalLoans, totalInterestCollected, totalFineCollected, cashBalance };
    }

    /************** HOME **************/
    function renderHome(){
      const t = totals();
      homeSection.innerHTML = `
        <h2 style="margin:0 0 8px 0">Summary</h2>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px;margin-bottom:10px">
          <div style="padding:10px;border:1px solid #e6e7ea;border-radius:8px;">Total Members<br><strong>${t.totalMembers}</strong></div>
          <div style="padding:10px;border:1px solid #e6e7ea;border-radius:8px;">Total Shares<br><strong>${t.totalShares}</strong></div>
          <div style="padding:10px;border:1px solid #e6e7ea;border-radius:8px;">Total Deposits<br><strong>₹${t.totalDeposits}</strong></div>
          <div style="padding:10px;border:1px solid #e6e7ea;border-radius:8px;">Total Loans<br><strong>₹${t.totalLoans}</strong></div>
          <div style="padding:10px;border:1px solid #e6e7ea;border-radius:8px;">Total Interest Collected<br><strong>₹${t.totalInterestCollected}</strong></div>
          <div style="padding:10px;border:1px solid #e6e7ea;border-radius:8px;">Total Fine Collected<br><strong>₹${t.totalFineCollected}</strong></div>
          <div style="padding:10px;border:1px solid #e6e7ea;border-radius:8px;">Cash Balance<br><strong>₹${t.cashBalance}</strong></div>
        </div>
        <div style="display:flex;gap:8px">
          <button id="exportCsv" class="btn gray">Export Transactions CSV</button>
          <button id="resetData" class="btn red">Reset Data</button>
        </div>
      `;
      document.getElementById('exportCsv').addEventListener('click', exportCSV);
      document.getElementById('resetData').addEventListener('click', resetAll);
    }

    /************** MEMBERS **************/
    function renderMembers(){
      // Build static add-members form area (we will keep inputs as DOM nodes, not re-create them on each update to avoid focus loss)
      membersSection.innerHTML = '';
      const title = document.createElement('h2'); title.textContent = 'Members'; title.style.margin='0 0 8px 0';
      membersSection.appendChild(title);

      // Add-member form (we create inputs once)
      const form = document.createElement('div'); form.className='row'; form.style.marginBottom='10px';
      const inName = document.createElement('input'); inName.type='text'; inName.placeholder='Name'; inName.id='add_name';
      const inPhone = document.createElement('input'); inPhone.type='text'; inPhone.placeholder='Phone (optional)'; inPhone.id='add_phone';
      const inShares = document.createElement('input'); inShares.type='number'; inShares.min='1'; inShares.value='1'; inShares.style.width='90px'; inShares.id='add_shares';
      const addBtn = document.createElement('button'); addBtn.textContent='Add Member'; addBtn.className='btn primary';
      form.appendChild(inName); form.appendChild(inPhone); form.appendChild(inShares); form.appendChild(addBtn);
      membersSection.appendChild(form);

      const tip = document.createElement('div'); tip.className='small muted'; tip.textContent = 'Tip: type freely — the caret will not disappear. Press Add Member when ready.'; tip.style.marginTop='6px';
      membersSection.appendChild(tip);

      // Table area
      const tableWrap = document.createElement('div'); tableWrap.style.marginTop='12px';
      const table = document.createElement('table');
      table.innerHTML = '<thead><tr><th>Name</th><th>Phone</th><th>Shares</th><th>Last Contrib</th><th>Actions</th></tr></thead><tbody id="members_tbody"></tbody>';
      tableWrap.appendChild(table);
      membersSection.appendChild(tableWrap);

      // Add button handler
      addBtn.addEventListener('click', ()=>{
        const name = inName.value.trim();
        const phone = inPhone.value.trim();
        const shares = Number(inShares.value) || 1;
        if(!name){ alert('Enter member name'); inName.focus(); return; }
        const m = { id: uid(), name, phone, shares, lastContribution: null, weeklyRecords: [], loans: [] };
        members.push(m);
        save(KEY_MEM, members);
        inName.value=''; inPhone.value=''; inShares.value='1';
        inName.focus();
        renderMembersTable(); // update table
      });

      // Render table rows
      function renderMembersTable(){
        const tbody = membersSection.querySelector('#members_tbody');
        tbody.innerHTML = '';
        if(members.length === 0){
          const tr = document.createElement('tr'); tr.innerHTML = '<td colspan="5" class="small">No members yet</td>'; tbody.appendChild(tr); return;
        }
        members.forEach(m=>{
          const tr = document.createElement('tr');
          const nameCell = document.createElement('td');
          const nameBtn = document.createElement('button'); nameBtn.textContent = m.name; nameBtn.style.background='transparent'; nameBtn.style.border='0'; nameBtn.style.color='#0b69ff'; nameBtn.style.cursor='pointer';
          nameBtn.addEventListener('click', ()=> { alert('Attendance for '+m.name + '\\n\\n' + memberReportText(m)); });
          nameCell.appendChild(nameBtn);

          const phoneCell = document.createElement('td'); phoneCell.textContent = m.phone || '—';
          const sharesCell = document.createElement('td'); sharesCell.textContent = m.shares;
          const lastCell = document.createElement('td'); lastCell.textContent = m.lastContribution || '—';
          const actionsCell = document.createElement('td');
          const editBtn = document.createElement('button'); editBtn.textContent='Edit'; editBtn.className='btn'; editBtn.addEventListener('click', ()=> editMemberPrompt(m.id));
          actionsCell.appendChild(editBtn);
          tr.appendChild(nameCell); tr.appendChild(phoneCell); tr.appendChild(sharesCell); tr.appendChild(lastCell); tr.appendChild(actionsCell);
          tbody.appendChild(tr);
        });
      }

      function editMemberPrompt(id){
        const m = members.find(x=>x.id===id); if(!m) return;
        const newName = prompt('Edit name:', m.name); if(newName===null) return;
        const newPhone = prompt('Edit phone:', m.phone || ''); if(newPhone===null) return;
        const newShares = prompt('Edit shares (number):', String(m.shares)); if(newShares===null) return;
        m.name = newName.trim(); m.phone = newPhone.trim(); m.shares = Number(newShares) || 1;
        save(KEY_MEM, members);
        renderMembersTable();
      }

      function memberReportText(m){
        if(!m.weeklyRecords || m.weeklyRecords.length===0) return 'No weekly records yet.';
        const recs = m.weeklyRecords.slice().sort((a,b)=> b.weekDate.localeCompare(a.weekDate));
        return recs.map(r => `${r.weekDate} | ${r.status.toUpperCase()} | Amt ₹${r.amount||0} | Fine ₹${r.fine||0}`).join('\\n');
      }

      renderMembersTable();
    }

    /************** WEEKLY ENTRY **************/
    function renderWeekly(){
      weeklySection.innerHTML = '';
      const title = document.createElement('h2'); title.textContent = 'Weekly Entry'; title.style.margin='0 0 8px 0';
      weeklySection.appendChild(title);

      const controls = document.createElement('div'); controls.className='row';
      const lbl = document.createElement('label'); lbl.className='small'; lbl.textContent='Select week date (choose Sunday):';
      const dateInp = document.createElement('input'); dateInp.type='date'; dateInp.value = new Date().toISOString().slice(0,10);
      controls.appendChild(lbl); controls.appendChild(dateInp);
      weeklySection.appendChild(controls);

      const info = document.createElement('div'); info.className='muted small'; info.textContent = 'Then mark each member: Deposit or Skipped (fine = ₹5 × shares).';
      weeklySection.appendChild(info);

      const tableWrap = document.createElement('div'); tableWrap.style.marginTop='12px';
      const table = document.createElement('table');
      table.innerHTML = '<thead><tr><th>Name</th><th>Shares</th><th>Suggested Due</th><th>Mark</th></tr></thead><tbody id="weekly_tbody"></tbody>';
      tableWrap.appendChild(table);
      weeklySection.appendChild(tableWrap);

      function renderWeeklyRows(){
        const tbody = weeklySection.querySelector('#weekly_tbody');
        tbody.innerHTML = '';
        if(members.length === 0){
          tbody.innerHTML = '<tr><td colspan="4" class="small">No members</td></tr>'; return;
        }
        const week = dateInp.value;
        members.forEach(m=>{
          const tr = document.createElement('tr');
          const nameTd = document.createElement('td'); nameTd.textContent = m.name;
          const sharesTd = document.createElement('td'); sharesTd.textContent = m.shares;
          const suggested = (m.shares||0) * UNIT;
          const suggestedTd = document.createElement('td'); suggestedTd.textContent = '₹'+suggested;
          const markTd = document.createElement('td');
          // check if already has record for week
          const existing = (m.weeklyRecords||[]).find(r=> r.weekDate === week);
          if(existing){
            const span = document.createElement('span'); span.className='small'; span.textContent = `${existing.status.toUpperCase()} (₹${existing.amount||0} + fine ₹${existing.fine||0})`;
            markTd.appendChild(span);
          } else {
            const depBtn = document.createElement('button'); depBtn.textContent='Deposit'; depBtn.className='btn green'; depBtn.addEventListener('click', ()=> {
              const s = prompt(`Enter deposit amount for ${m.name} (suggested ₹${suggested}):`, String(suggested));
              if(s===null) return; const amt = Number(s); if(isNaN(amt)){ alert('Invalid amount'); return; }
              const rec = { id: uid(), weekDate: week, status:'deposit', amount: amt, fine:0, recordedAt: nowISO() };
              m.weeklyRecords = m.weeklyRecords || []; m.weeklyRecords.push(rec); m.lastContribution = week;
              txns.unshift({ id: uid(), date: nowLocale(), dateISO: nowISO(), memberId: m.id, memberName: m.name, type:'contribution', amount: amt, details:{ week }});
              save(KEY_MEM, members); save(KEY_TXN, txns); renderWeeklyRows(); alert('Deposit recorded');
            });
            const skipBtn = document.createElement('button'); skipBtn.textContent='Skipped'; skipBtn.className='btn red'; skipBtn.style.marginLeft='8px'; skipBtn.addEventListener('click', ()=> {
              const suggestedFine = (m.shares||0) * FINE_PER_SHARE;
              const sf = prompt(`Mark SKIPPED for ${m.name}. Suggested fine ₹${suggestedFine}. Enter fine to apply (0 to waive):`, String(suggestedFine));
              if(sf===null) return; const fine = Number(sf); if(isNaN(fine)){ alert('Invalid'); return; }
              const rec = { id: uid(), weekDate: week, status:'skipped', amount:0, fine: fine, recordedAt: nowISO() };
              m.weeklyRecords = m.weeklyRecords || []; m.weeklyRecords.push(rec);
              txns.unshift({ id: uid(), date: nowLocale(), dateISO: nowISO(), memberId: m.id, memberName: m.name, type:'skipped', amount: fine, details:{ week }});
              save(KEY_MEM, members); save(KEY_TXN, txns); renderWeeklyRows(); alert('Skipped recorded (fine applied)');
            });
            markTd.appendChild(depBtn); markTd.appendChild(skipBtn);
          }
          tr.appendChild(nameTd); tr.appendChild(sharesTd); tr.appendChild(suggestedTd); tr.appendChild(markTd);
          tbody.appendChild(tr);
        });
      }

      dateInp.addEventListener('change', renderWeeklyRows);
      renderWeeklyRows();
    }

    /************** LOAN **************/
    function renderLoan(){
      loanSection.innerHTML = '';
      const title = document.createElement('h2'); title.textContent = 'Loan Management'; title.style.margin='0 0 8px 0';
      loanSection.appendChild(title);

      // Loan table: list members and actions
      const table = document.createElement('table');
      table.innerHTML = '<thead><tr><th>Member</th><th>Issue Loan</th><th>Principal Outstanding</th><th>Interest Due</th><th>Actions</th></tr></thead><tbody id="loan_tbody"></tbody>';
      loanSection.appendChild(table);

      function monthsBetween(issueISO, now = new Date()){
        const issue = new Date(issueISO);
        const diffDays = Math.floor((now - issue) / (1000*60*60*24));
        return Math.floor(diffDays / 30); // approximate months by 30-day periods (simple interest)
      }

      function calcInterestDue(loan){
        // simple interest 3% per month on original principal? We will calculate on outstanding principal:
        // interestDue = (original principal or outstanding?) -> spec: simple interest based on principal since issue.
        // We'll calculate based on loan.principal (original) for months elapsed, then subtract interest already paid.
        const months = monthsBetween(loan.issuedAt);
        const accumulated = loan.principal * MONTHLY_INTEREST_RATE * months;
        const paid = (loan.interestPayments || []).reduce((s,p)=> s + (p.amount||0), 0);
        const due = Math.max(0, accumulated - paid);
        return { months, accumulated, paid, due };
      }

      function renderLoanRows(){
        const tbody = loanSection.querySelector('#loan_tbody');
        tbody.innerHTML = '';
        if(members.length === 0){
          tbody.innerHTML = '<tr><td colspan="5" class="small">No members</td></tr>'; return;
        }
        members.forEach(m=>{
          const tr = document.createElement('tr');
          const nameTd = document.createElement('td'); nameTd.textContent = m.name;
          // issue loan button
          const issueTd = document.createElement('td'); const issueBtn = document.createElement('button'); issueBtn.textContent='Issue Loan'; issueBtn.className='btn primary';
          issueBtn.addEventListener('click', ()=>{
            const s = prompt(`Enter loan principal for ${m.name}:`); if(s===null) return;
            const amt = Number(s); if(isNaN(amt) || amt<=0){ alert('Invalid'); return; }
            // create loan object
            const loan = { id: uid(), principal: amt, outstanding: amt, issuedAt: nowISO(), interestPayments:[], principalPayments:[] };
            m.loans = m.loans || []; m.loans.push(loan);
            txns.unshift({ id: uid(), date: nowLocale(), dateISO: nowISO(), memberId: m.id, memberName: m.name, type:'loan', amount: amt });
            save(KEY_MEM, members); save(KEY_TXN, txns); renderLoanRows(); alert('Loan issued');
          }); issueTd.appendChild(issueBtn);

          // principal outstanding (sum of outstanding)
          const principalOutstanding = (m.loans || []).reduce((s,l)=> s + (l.outstanding||0), 0);
          const princTd = document.createElement('td'); princTd.textContent = '₹'+principalOutstanding;

          // interest due: sum across loans
          const interestDueTotal = (m.loans || []).reduce((s,l)=> {
            const info = calcInterestDue(l);
            return s + info.due;
          }, 0);
          const interestTd = document.createElement('td'); interestTd.textContent = '₹'+interestDueTotal;

          // actions: for each active loan, show deposit principal & deposit interest buttons
          const actionsTd = document.createElement('td');
          if((m.loans||[]).filter(l=> l.outstanding>0).length === 0){
            actionsTd.innerHTML = '<span class="small">No active loans</span>';
          } else {
            (m.loans||[]).forEach(l=>{
              if(l.outstanding <= 0) return;
              const container = document.createElement('div'); container.style.marginBottom='8px';
              container.innerHTML = `<div style="margin-bottom:6px">Loan ₹${l.principal} (outstanding ₹${l.outstanding})</div>`;
              const payPr = document.createElement('button'); payPr.textContent = 'Deposit Principal'; payPr.className='btn'; payPr.addEventListener('click', ()=>{
                const s = prompt(`Outstanding ₹${l.outstanding}. Enter principal repayment amount:`, String(l.outstanding)); if(s===null) return;
                const amt = Number(s); if(isNaN(amt) || amt<=0){ alert('Invalid'); return; }
                l.outstanding = Math.max(0, (l.outstanding||0) - amt);
                l.principalPayments = l.principalPayments || []; l.principalPayments.push({ id: uid(), amount: amt, dateISO: nowISO() });
                txns.unshift({ id: uid(), date: nowLocale(), dateISO: nowISO(), memberId: m.id, memberName: m.name, type:'repayment', amount: amt, details:{ loanId: l.id }});
                save(KEY_MEM, members); save(KEY_TXN, txns); renderLoanRows(); alert('Principal repayment recorded');
              });
              const payInt = document.createElement('button'); payInt.textContent='Deposit Interest'; payInt.className='btn green'; payInt.style.marginLeft='8px'; payInt.addEventListener('click', ()=>{
                // calculate interest due for this loan
                const info = calcInterestDue(l);
                const suggested = Math.ceil(info.due); // suggested rounded
                const s = prompt(`Interest due (since issue) = ₹${info.due.toFixed(2)}. Enter interest payment:`, String(suggested)); if(s===null) return;
                const amt = Number(s); if(isNaN(amt) || amt<0){ alert('Invalid'); return; }
                l.interestPayments = l.interestPayments || []; l.interestPayments.push({ id: uid(), amount: amt, dateISO: nowISO() });
                txns.unshift({ id: uid(), date: nowLocale(), dateISO: nowISO(), memberId: m.id, memberName: m.name, type:'interest', amount: amt, details:{ loanId: l.id }});
                save(KEY_MEM, members); save(KEY_TXN, txns); renderLoanRows(); alert('Interest payment recorded');
              });
              container.appendChild(payPr); container.appendChild(payInt);
              actionsTd.appendChild(container);
            });
          }

          tr.appendChild(nameTd); tr.appendChild(issueTd); tr.appendChild(princTd); tr.appendChild(interestTd); tr.appendChild(actionsTd);
          tbody.appendChild(tr);
        });
      }

      renderLoanRows();
    }

    /************** CSV & Reset **************/
    function exportCSV(){
      if(!txns || txns.length===0){ alert('No transactions to export'); return; }
      const header = ['Date','Member','Type','Amount','Details'];
      const rows = txns.map(t => [t.date, t.memberName, t.type, t.amount||'', JSON.stringify(t.details||'')]);
      const csv = [header, ...rows].map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\\n');
      const blob = new Blob([csv], { type:'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'samity_transactions.csv'; a.click(); URL.revokeObjectURL(url);
    }
    function resetAll(){
      if(!confirm('Clear ALL data? This cannot be undone.')) return;
      members = []; txns = []; save(KEY_MEM, members); save(KEY_TXN, txns);
      showTab('home');
    }

    // Wire global functions for Home buttons (they are created when home rendered)
    function exportCSV(){ /* wrapper used earlier - redefined here to avoid hoisting issues */ 
      if(!txns || txns.length===0){ alert('No transactions to export'); return; }
      const header = ['Date','Member','Type','Amount','Details'];
      const rows = txns.map(t => [t.date, t.memberName, t.type, t.amount||'', JSON.stringify(t.details||'')]);
      const csv = [header, ...rows].map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\\n');
      const blob = new Blob([csv], { type:'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'samity_transactions.csv'; a.click(); URL.revokeObjectURL(url);
    }

    // Expose helper to render home after changes
    function showTab(tab){
      // set active nav
      tabs.forEach(t => document.getElementById('tab-'+t).classList.toggle('active', t===tab));
      // show/hide
      homeSection.style.display = tab==='home' ? 'block' : 'none';
      membersSection.style.display = tab==='members' ? 'block' : 'none';
      weeklySection.style.display = tab==='weekly' ? 'block' : 'none';
      loanSection.style.display = tab==='loan' ? 'block' : 'none';
      // call renders
      if(tab==='home') renderHome();
      if(tab==='members') renderMembers();
      if(tab==='weekly') renderWeekly();
      if(tab==='loan') renderLoan();
    }

    // Re-bind nav buttons (since we declared showTab above)
    tabs.forEach(t => document.getElementById('tab-'+t).addEventListener('click', ()=> showTab(t)));

    // Save wrappers used inside other functions must point to outer save
    // (we already call save directly in functions above)

    // Show initial home
    showTab('home');

    // Make export and reset functions available for home buttons (they are created on renderHome)
    // We also need to ensure other modules can call save(KEY_MEM, members) etc. Already used.

  })();
  </script>
</body>
</html>
